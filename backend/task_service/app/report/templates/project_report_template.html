<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ report_title | default('Project Report') }}</title>
<style>
    /* --- General Setup --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    @page {
        size: A4;
        margin: 20mm 15mm 20mm 15mm;
    }
    body {
        font-family: 'Inter', Arial, sans-serif;
        font-size: 12px;
        color: #333;
        background-color: #fff;
        margin: 0;
        padding: 0;
    }

    .report-container {
        width: 100%;
        max-width: 190mm;
        margin: 0 auto;
        padding: 0;
    }

    h1, h2, h3 {
        color: #1a253c;
        font-weight: 600;
        margin-top: 0;
    }
    h1 { font-size: 20px; margin-bottom: 6px; }
    h2 { font-size: 15px; margin-top: 18px; border-bottom: 1px solid #dbe3e0; padding-bottom: 4px; }
    h3 { font-size: 13px; }

    /* --- Report Header --- */
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    .report-header h1 {
        color: #3498db;
    }
    .report-meta {
        text-align: right;
        font-size: 11px;
        color: #555;
    }
    .report-meta div { margin-bottom: 3px; }

    /* --- Project Details --- */
    .project-details {
        background: #fafafa;
        border: 1px solid #eef1f3;
        padding: 10px 12px;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.5;
    }

    /* --- KPI Summary Grid --- */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
        margin-bottom: 20px;
        page-break-inside: avoid;
    }
    .kpi-card {
        background: #f9fbfd;
        border: 1px solid #eef1f3;
        border-radius: 6px;
        padding: 12px;
    }
    .kpi-label {
        font-size: 11px;
        font-weight: 500;
        color: #5a6b8c;
        margin-bottom: 4px;
    }
    .kpi-value {
        font-size: 20px;
        font-weight: 700;
        color: #1a253c;
    }
    .kpi-card.overdue-card { border-left: 4px solid #e74c3c; }
    .kpi-card.completed-card { border-left: 4px solid #2ecc71; }

    /* --- Task Table --- */
    .task-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 11px;
        word-wrap: break-word;
        table-layout: fixed;
    }
    .task-table th, .task-table td {
        border: 1px solid #dce3ea;
        padding: 6px 8px;
        text-align: left;
        vertical-align: top;
    }
    .task-table th {
        background-color: #f8faff;
        color: #2f3a56;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 10px;
    }
    .task-table td {
        white-space: normal;
        overflow-wrap: break-word;
    }
    .task-table tr:nth-child(even) { background-color: #fbfcfd; }

    .no-tasks-row td {
        text-align: center;
        padding: 20px;
        color: #777;
        font-size: 13px;
    }

    /* --- Status & Priority Tags --- */
    .status-tag {
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 500;
        font-size: 10px;
        display: inline-block;
        line-height: 1.3;
    }
    .status-tag.status-Unassigned { background-color: #e4e7eb; color: #5a6b8c; }
    .status-tag.status-Ongoing { background-color: #dbeafe; color: #2563eb; }
    .status-tag.status-Under-Review { background-color: #fef3c7; color: #d97706; }
    .status-tag.status-Completed { background-color: #d1fae5; color: #057a55; }
    .status-tag.status-Overdue { background-color: #ffe4e6; color: #e74c3c; }

    .priority-display { display: flex; align-items: center; }
    .priority-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
        flex-shrink: 0;
    }
    .priority-dot.priority-low { background-color: #2ecc71; }
    .priority-dot.priority-medium { background-color: #f39c12; }
    .priority-dot.priority-high { background-color: #e74c3c; }

    /* --- Footer --- */
    .report-footer {
        margin-top: 20px;
        text-align: center;
        font-size: 10px;
        color: #999;
        border-top: 1px solid #eef1f3;
        padding-top: 10px;
    }

    /* --- Print Optimization --- */
    @media print {
        body {
            background: #fff;
            margin: 0;
        }
        .report-header, .kpi-grid, .task-table, .project-details {
            page-break-inside: avoid;
        }
        h2 {
            page-break-before: avoid;
        }
        .report-footer {
            position: relative;
            bottom: 0;
            width: 100%;
            page-break-before: auto;
        }
    }
</style>
</head>
<body>
<div class="report-container">
    <div class="report-header">
        <div>
            <h1>{{ report_title | default('Project Performance Report') }}</h1>
        </div>
        <div class="report-meta">
            <div><strong>Project:</strong> {{ project_name | default('N/A') }}</div>
            <div><strong>Period:</strong> {{ report_period | default('N/A') }}</div>
            <div><strong>Generated:</strong> {{ generation_date }}</div>
        </div>
    </div>

    <h2>Project Overview</h2>
    <div class="project-details">
        <strong>Project Owner:</strong> {{ project_owner | default('N/A') }}<br>
        <strong>Collaborators:</strong> {{ project_collaborators | default('N/A') }}
    </div>

    <h2>Key Metrics</h2>
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Total Tasks</div>
            <div class="kpi-value">{{ total_tasks | default(0) }}</div>
        </div>
        <div class="kpi-card completed-card">
            <div class="kpi-label">Completed</div>
            <div class="kpi-value">{{ status_counts['Completed'] | default(0) }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Ongoing</div>
            <div class="kpi-value">{{ status_counts['Ongoing'] | default(0) }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Under Review</div>
            <div class="kpi-value">{{ status_counts['Under Review'] | default(0) }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Unassigned</div>
            <div class="kpi-value">{{ status_counts['Unassigned'] | default(0) }}</div>
        </div>
        <div class="kpi-card overdue-card">
            <div class="kpi-label">Overdue</div>
            <div class="kpi-value">{{ overdue_count | default(0) }}</div>
        </div>
    </div>

    <h2>Task Details</h2>
    <table class="task-table">
        <thead>
            <tr>
                <th>Task Title</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Deadline</th>
                <th>Owner</th>
                <th>Collaborators</th>
                <th>Duration</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.title | default('N/A') }}</td>
                <td>
                    <span class="status-tag status-{{ task.status | replace(' ', '-') }}">{{ task.status | default('N/A') }}</span>
                    {% if task.is_overdue and task.status != 'Completed' %}
                        <span class="status-tag status-Overdue" style="margin-top: 3px;">Overdue</span>
                    {% endif %}
                </td>
                <td>
                    {% set priority_level = 'low' %}
                    {% if task.priority >= 8 %}{% set priority_level = 'high' %}
                    {% elif task.priority >= 4 %}{% set priority_level = 'medium' %}{% endif %}
                    <div class="priority-display">
                        <span class="priority-dot priority-{{ priority_level }}"></span>
                        <span>{{ task.priority | default('N/A') }} ({{ priority_level | capitalize }})</span>
                    </div>
                </td>
                <td>{{ task.deadline | default('N/A') }}</td>
                <td>{{ task.owner_name | default('N/A') }}</td>
                <td>{{ task.collaborator_names | default('N/A') }}</td>
                <td>{{ task.duration | default('N/A') }}</td>
            </tr>
            {% else %}
            <tr class="no-tasks-row">
                <td colspan="7">No tasks found for this project in the selected period.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="report-footer">
        Generated by Smart Task Management System
    </div>
</div>
</body>
</html>
